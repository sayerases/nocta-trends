<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nocta Trends Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="auth-overlay {% if not is_authenticated %}active{% endif %}">
        <div class="auth-card">
            <div class="brand-icon" style="margin: 0 auto 20px; width: 48px; height: 48px; font-size: 24px;">N</div>
            <h2 id="auth-title">Вход в систему</h2>

            <form id="login-form" class="auth-form" onsubmit="handleLogin(event)">
                <input type="email" id="login-email" class="input-field" placeholder="Email" required>
                <input type="password" id="login-password" class="input-field" placeholder="Пароль" required>
                <button type="submit" class="btn btn-primary"
                    style="justify-content: center; padding: 12px; font-size: 16px;">Войти</button>
                <p style="font-size: 13px; color: var(--text-muted); cursor: pointer;" onclick="toggleAuthMode()">У меня
                    нет аккаунта (Регистрация)</p>
            </form>

            <form id="register-form" class="auth-form" style="display: none;" onsubmit="handleRegister(event)">
                <input type="text" id="reg-name" class="input-field" placeholder="Ваше Имя" required>
                <input type="email" id="reg-email" class="input-field" placeholder="Email" required>
                <input type="password" id="reg-password" class="input-field" placeholder="Пароль" required>
                <button type="submit" class="btn btn-primary"
                    style="justify-content: center; padding: 12px; font-size: 16px;">Создать аккаунт</button>
                <p style="font-size: 13px; color: var(--text-muted); cursor: pointer;" onclick="toggleAuthMode()">Уже
                    есть аккаунт? Войти</p>
            </form>
            <div id="auth-error" style="color: var(--danger); font-size: 13px; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-icon">N</div>
            Nocta <span style="font-weight: 400; font-size: 12px; color: var(--text-muted);">Pro</span>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">Поиск Контента</div>
            <a href="#" class="nav-link active" data-page="home" onclick="loadPage('home', event)">
                <svg class="icon">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg> Главная
            </a>
            <a href="#" class="nav-link" data-page="search" onclick="loadPage('search', event)">
                <svg class="icon">
                    <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                </svg> Поиск по слову
            </a>
            <a href="#" class="nav-link" data-page="radar" onclick="loadPage('radar', event)">
                <svg class="icon">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                </svg> Контент-радар
            </a>
            <a href="#" class="nav-link" data-page="spy" onclick="loadPage('spy', event)">
                <svg class="icon">
                    <path
                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                </svg> Шпионаж
            </a>
            <a href="#" class="nav-link" data-page="anomalous" onclick="loadPage('anomalous', event)">
                <svg class="icon">
                    <path d="M21 3H3v18h18V3zM9 17H7v-4h2v4zm4 0h-2v-6h2v6zm4 0h-2V7h2v10z" />
                </svg> Аномальные видео
            </a>

            <div class="nav-section">Инструменты</div>
            <a href="#" class="nav-link" data-page="video-analysis" onclick="loadPage('video-analysis', event)">
                <svg class="icon">
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg> Анализ видео
            </a>
            <a href="#" class="nav-link" data-page="profile" onclick="loadPage('profile', event)">
                <svg class="icon">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg> Анализ профиля
            </a>

            <div class="nav-section">Идеи</div>
            <a href="#" class="nav-link" data-page="favorites" onclick="loadPage('favorites', event)">
                <svg class="icon" style="color: var(--danger)">
                    <path
                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg> Избранные
            </a>
            <a href="#" class="nav-link" data-page="history" onclick="loadPage('history', event)">
                <svg class="icon">
                    <path
                        d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                </svg> История
            </a>

            {% if user and user.role == 'admin' %}
            <div class="nav-section">Админ</div>
            <a href="#" class="nav-link" data-page="admin" onclick="loadPage('admin-page', event)">
                <svg class="icon">
                    <path
                        d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                </svg> Панель
            </a>
            {% endif %}
        </nav>

        {% if is_authenticated %}
        <div class="user-box">
            <div class="user-info">
                <div class="user-name" id="display-user-name">{{ user.name }}</div>
                <div class="token-balance">
                    <svg class="icon" style="width:14px;height:14px;">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                    </svg>
                    <span id="display-user-tokens">{{ user.tokens }}</span> токенов
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()" title="Выйти" style="cursor: pointer; z-index: 50;">
                <svg class="icon">
                    <path
                        d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
                </svg>
            </button>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content -->
    <main class="main-wrapper">
        <header class="topbar">
            <h1 class="page-title" id="topbar-title">Банк идей</h1>
        </header>
        <div class="content-area" id="page-content">
            <!-- Partials injected here -->
        </div>
    </main>

    <!-- Global Video Modal -->
    <div id="video-modal" class="modal-overlay" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <button class="close-modal" aria-label="Закрыть" onclick="closeModal()"
                style="z-index: 10000; pointer-events: auto;">×</button>
            <div class="modal-left">
                <img id="modal-video" src="" alt="Video Thumbnail">
                <div class="header-badge" style="top: 20px; left: 20px; font-size: 12px; z-index: 10;">REELS</div>
            </div>
            <div class="modal-right">
                <div style="display:flex; justify-content:space-between; margin-bottom: 24px;">
                    <h2 id="modal-author" style="font-size: 20px;"></h2>
                    <a id="modal-link" href="#" target="_blank" class="btn">Открыть ↗</a>
                </div>

                <div class="admin-stats"
                    style="margin-bottom: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background:var(--panel-bg); padding:16px; border-radius:12px; text-align:center;">
                        <span style="font-size:24px; font-weight:700;" id="modal-views">0</span>
                        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Просмотры</div>
                    </div>
                    <div style="background:var(--panel-bg); padding:16px; border-radius:12px; text-align:center;">
                        <span style="font-size:24px; font-weight:700;" id="modal-likes">0</span>
                        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Лайки</div>
                    </div>
                    <div style="background:var(--panel-bg); padding:16px; border-radius:12px; text-align:center;">
                        <span id="modal-comments" style="font-size:24px; font-weight:700;">0</span>
                        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Комменты</div>
                    </div>
                    <div style="background:var(--panel-bg); padding:16px; border-radius:12px; text-align:center;">
                        <span style="font-size:24px; font-weight:700; color:var(--success);" id="modal-er">0%</span>
                        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">ER</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div
                    style="display:flex; gap:10px; margin-bottom:20px; background:rgba(255,255,255,0.05); padding:6px; border-radius:12px;">
                    <button class="btn"
                        style="flex:1; justify-content:center; background:rgba(255,255,255,0.1); border-color:transparent;"
                        id="tab-transcript" onclick="switchModalTab('transcript')">Транскрипция</button>
                    <button class="btn" style="flex:1; justify-content:center; border-color:transparent;"
                        id="tab-analysis" onclick="switchModalTab('analysis')">AI Анализ (10 т.)</button>
                </div>

                <div id="content-transcript" style="font-size:14px; line-height:1.6; color:#ccc; white-space:pre-wrap;">
                </div>
                <div id="content-analysis" style="display:none; font-size:14px; line-height:1.6; color:#ccc;">
                    <div style="text-align:center; margin-top:40px;">
                        <button class="btn btn-primary" onclick="runAiAnalysis()">Запустить глубокий анализ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isAuth = {{ 'true' if is_authenticated else 'false' }};
        let currentPage = 'home';
        let currentSearchPage = 1;
        let isLoading = false;
        let isAuthModeLogin = true;

        /* --- AUTH METHODS --- */
        function toggleAuthMode() {
            isAuthModeLogin = !isAuthModeLogin;
            document.getElementById('login-form').style.display = isAuthModeLogin ? 'flex' : 'none';
            document.getElementById('register-form').style.display = isAuthModeLogin ? 'none' : 'flex';
            document.getElementById('auth-title').innerText = isAuthModeLogin ? 'Вход в систему' : 'Регистрация';
            document.getElementById('auth-error').innerText = '';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;

            const fd = new FormData(); fd.append('email', email); fd.append('password', pass);
            const r = await fetch('/auth/login', { method: 'POST', body: fd });
            const data = await r.json();

            if (data.status === 'ok') { location.reload(); }
            else { document.getElementById('auth-error').innerText = data.message; }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;

            const fd = new FormData(); fd.append('email', email); fd.append('password', pass); fd.append('name', name);
            const r = await fetch('/auth/register', { method: 'POST', body: fd });
            const data = await r.json();

            if (data.status === 'ok') { location.reload(); }
            else { document.getElementById('auth-error').innerText = data.message; }
        }

        async function handleLogout() {
            if (confirm('Выйти из аккаунта?')) {
                window.location.href = '/auth/logout';
            }
        }

        /* --- NAVIGATION --- */
        function loadPage(page, event) {
            if (event) event.preventDefault();
            if (!isAuth) {
                document.getElementById('auth-overlay').classList.add('active');
                return;
            }

            currentPage = page;
            currentSearchPage = 1;

            document.querySelectorAll('.nav-link').forEach(a => {
                a.classList.toggle('active', a.dataset.page === page);
            });

            const pc = document.getElementById('page-content');
            pc.innerHTML = '<div style="display:flex;justify-content:center;padding:60px;"><div class="spinner"></div></div>';

            const endpoints = {
                'home': '/api/home',
                'search': '/api/search',
                'radar': '/api/radar-page',
                'spy': '/api/spy-page',
                'anomalous': '/api/anomalous-page',
                'video-analysis': '/api/video-analysis-page',
                'profile': '/api/profile-page',
                'favorites': '/api/favorites-page',
                'history': '/api/history-page',
                'admin-page': '/api/admin-page'
            };

            const titles = {
                'home': 'Банк идей', 'search': 'Поиск', 'radar': 'Контент-радар',
                'spy': 'Шпионаж конкурентов', 'anomalous': 'Аномально вирусные видео',
                'video-analysis': 'AI Анализ ролика', 'profile': 'Глубокий анализ профиля',
                'favorites': 'Сохраненные референсы', 'history': 'История поисков',
                'admin-page': 'Панель Управления'
            };
            document.getElementById('topbar-title').innerText = titles[page];

            fetch(endpoints[page])
                .then(r => {
                    if (r.status === 401 || r.status === 403) return "<div class='auth-required'>Доступ запрещен</div>";
                    return r.text();
                })
                .then(html => {
                    pc.innerHTML = html;
                    setupInfiniteScroll();
                    if (page === 'home') loadHomeContent();
                    if (page === 'anomalous') loadAnomalousContent();
                });
        }

        /* --- HOME & INFINITE SCROLL --- */
        function loadHomeContent() {
            const grid = document.getElementById('video-grid-container');
            if (!grid) return;
            grid.innerHTML = '<div style="grid-column:1/-1;display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>';
            fetch('/api/home/feed?page=1')
                .then(r => r.text()).then(html => { grid.innerHTML = html; setupInfiniteScroll(); });
        }

        function loadAnomalousContent() {
            const grid = document.getElementById('video-grid-container');
            if (!grid) return;
            grid.innerHTML = '<div style="grid-column:1/-1;display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>';
            fetch('/api/anomalous?page=1')
                .then(r => r.text()).then(html => { grid.innerHTML = html; setupInfiniteScroll(); });
        }

        let scrollObserver = null;
        function setupInfiniteScroll() {
            const sentinels = document.querySelectorAll('.scroll-sentinel');
            if (!sentinels || sentinels.length === 0) return;
            const sentinel = sentinels[sentinels.length - 1]; // Pick the last sentinel

            if (scrollObserver) scrollObserver.disconnect();

            scrollObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadMoreContent();
                }
            }, { rootMargin: '200px' });

            scrollObserver.observe(sentinel);
        }

        function loadMoreContent() {
            isLoading = true;
            currentSearchPage++;
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.style.display = 'block';

            let url = '';
            if (currentPage === 'search') {
                const q = document.getElementById('main-search-input')?.value || '';
                const tf = document.getElementById('time-select')?.value || 'all';
                const sort = document.getElementById('sort-select')?.value || 'views';
                url = `/api/search?q=${encodeURIComponent(q)}&timeframe=${tf}&sort_by=${sort}&page=${currentSearchPage}`;
            } else if (currentPage === 'home') {
                url = `/api/home/feed?page=${currentSearchPage}`;
            } else if (currentPage === 'anomalous') {
                const sort = document.getElementById('sort-select')?.value || 'anomaly';
                const tf = document.getElementById('time-select')?.value || '3d';
                url = `/api/anomalous?sort_by=${sort}&timeframe=${tf}&page=${currentSearchPage}`;
            } else {
                isLoading = false; return;
            }

            fetch(url)
                .then(r => r.text())
                .then(html => {
                    const mainGrid = document.getElementById('main-grid');
                    if (mainGrid) {
                        mainGrid.insertAdjacentHTML('beforeend', html);
                    } else {
                        const grid = document.getElementById('video-grid-container');
                        if (grid) grid.insertAdjacentHTML('beforeend', html);
                    }
                    if (spinner) spinner.style.display = 'none';
                    isLoading = false;
                    setupInfiniteScroll(); // Re-bind observer to the new sentinel
                });
        }

        function reloadSearchGrid() {
            currentSearchPage = 1;
            const grid = document.getElementById('video-grid-container');
            if (grid) grid.innerHTML = '<div style="grid-column:1/-1;display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>';

            const q = document.getElementById('main-search-input')?.value || '';
            const tf = document.getElementById('time-select')?.value || 'all';
            const sort = document.getElementById('sort-select')?.value || 'views';

            fetch(`/api/search?q=${encodeURIComponent(q)}&timeframe=${tf}&sort_by=${sort}&page=1`)
                .then(r => r.text()).then(html => { grid.innerHTML = html; setupInfiniteScroll(); });
        }

        function reloadAnomalousGrid() {
            currentSearchPage = 1;
            const grid = document.getElementById('video-grid-container');
            if (grid) grid.innerHTML = '<div style="grid-column:1/-1;display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>';

            const tf = document.getElementById('time-select')?.value || '3d';
            const sort = document.getElementById('sort-select')?.value || 'anomaly';

            fetch(`/api/anomalous?sort_by=${sort}&timeframe=${tf}&page=1`)
                .then(r => r.text()).then(html => { grid.innerHTML = html; setupInfiniteScroll(); });
        }

        /* --- FAVORITES --- */
        function toggleFavorite(event, elem) {
            event.stopPropagation();
            if (!isAuth) { alert("Войдите в систему!"); return; }

            const vdata = JSON.parse(elem.dataset.video);
            const isFav = elem.classList.contains('active');

            const url = isFav ? '/api/favorites/remove' : '/api/favorites/add';
            fetch(url, {
                method: 'POST', body: JSON.stringify({ video_url: vdata.video_url, video: vdata }),
                headers: { 'Content-Type': 'application/json' }
            }).then(r => r.json()).then(res => {
                if (res.status === 'ok') {
                    elem.classList.toggle('active');
                    elem.style.color = isFav ? 'var(--text-muted)' : 'var(--danger)';
                }
            });
        }

        /* --- MODAL --- */
        let currentModalVideoId = "";
        let currentModalPlatform = "";

        function openVideoModal(videoJsonStr) {
            const data = JSON.parse(videoJsonStr);
            currentModalVideoId = data.platform_id || data.video_url;
            currentModalPlatform = data.platform || 'instagram';

            document.getElementById('modal-video').src = data.thumbnail_url;
            document.getElementById('modal-author').innerText = '@' + data.author;
            document.getElementById('modal-views').innerText = formatNum(data.views);
            document.getElementById('modal-likes').innerText = formatNum(data.likes);
            document.getElementById('modal-comments').innerText = formatNum(data.comments);
            document.getElementById('modal-er').innerText = (data.engagement_rate || 0) + '%';
            document.getElementById('modal-link').href = data.video_url;

            document.getElementById('content-transcript').innerText = data.transcript || "Нет описания/транскрипции.";
            document.getElementById('content-analysis').innerHTML = '<div style="text-align:center; margin-top:40px;"><button class="btn btn-primary" onclick="runAiAnalysis()">Запустить глубокий анализ (10 т.)</button></div>';

            switchModalTab('transcript');
            document.getElementById('video-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('video-modal').classList.remove('active');
        }

        function switchModalTab(tab) {
            document.getElementById('content-transcript').style.display = tab === 'transcript' ? 'block' : 'none';
            document.getElementById('content-analysis').style.display = tab === 'analysis' ? 'block' : 'none';

            document.getElementById('tab-transcript').style.background = tab === 'transcript' ? 'rgba(255,255,255,0.1)' : 'transparent';
            document.getElementById('tab-analysis').style.background = tab === 'analysis' ? 'rgba(255,255,255,0.1)' : 'transparent';
        }

        function runAiAnalysis() {
            const aContainer = document.getElementById('content-analysis');
            aContainer.innerHTML = '<div style="text-align:center; padding: 40px;"><div class="spinner" style="box-sizing:border-box;"></div><p style="margin-top:16px;">Нейросеть анализирует хук и триггеры...</p></div>';

            const fd = new FormData();
            fd.append('video_url', currentModalVideoId);
            fd.append('video_id', currentModalVideoId);
            fd.append('platform', currentModalPlatform);

            fetch('/api/analyze', { method: 'POST', body: fd })
                .then(r => r.text())
                .then(html => {
                    aContainer.innerHTML = html;
                }).catch(() => {
                    aContainer.innerHTML = '<div style="color:red;text-align:center;">Ошибка анализа. Проверьте баланс.</div>';
                });
        }

        function formatNum(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num;
        }

        // Init: Load home if logged in
        if (isAuth) { loadPage('home'); }
    </script>
</body>

</html>